{% extends 'website/base.html' %}

{% block content %}

<div class="container-event">
    <div class="row-event">
        <div class="item-event">
            <h2>{{ event_data.event_name }}</h2>
            <p>Event date:  {{ event_data.event_date }}</p>
            {% if event_data.draw_date %}
            <p>Draw date: {{ event_data.draw_date }}</p>
            {% endif %}
            <p><a href='{% url "event_update" pk=event_data.event_id %}'>edit event details</a></p>
            {% if event_data.confirmed %}
                    
                    <p><a href='{% url "event_deactivate" pk=event_data.event_id %}'>deactivate event</a> (all draw results will be cancelled)</p>
            {% else %}

                    
                    <p><a href='{% url "event_toggle_active" pk=event_data.event_id %}'>activate the event</a> (any updates will not be possible)</p>
            {% endif %}
            
        </div>
        <div class="item-event">
            <h2>other details</h2>
            
            <p>Confirmed: {{ event_data.confirmed }}</p>
            {% if event_data.event_location != '' %}
            <p>Event Location: {{ event_data.event_location }}</p>

            {% endif %}
        </div>
    </div>
    <div class="row-event">
        <div class="item-event">
            <h5>Event participants</h5>
            <p>Participants:</p>
                {% for participant in participants %}
                {{participant.1}}
                {{participant.3}}
                    {% if participant.3 %}
                    draw taken
                    {% else %}
                        {% if event_data.confirmed %}
                        <a href='{% url "send_reminder" pk=event_data.event_id participant_id=participant.2 %}'>Send a reminder.</a>
                        draw not taken.
                        {% endif %}


                    {% endif %}
                    </br>

                {% endfor %}
                {% if event_data.confirmed %}
                    <p><i>In order to add or edit pareticipants you should deactivate event first.</i></p>

                {% else %}

                    <p><a href='{% url "event_participants_update" pk=event_data.event_id %}'>edit paticipants</a></p>
                {% endif %}

        </div>
        <div class="item-event">
            <p>Excludes:</p>
                {% if excludes %}
                    {% for participant, excluded_list in excludes.items %}
                        {% for excluded in excluded_list %}
                            <p>{{participant}} cannot draw {{excluded}}</p>
                        {% endfor %}
                    {% endfor %}
                {% else %}
                    <p>Currently there is no excludes set for this event.</p>
                {% endif %}
                {% if event_data.confirmed %}
                    <p><i>In order to add or edit existing excludes you should deactivate event first.</i></p>
                    <p><a href='{% url "event_deactivate" pk=event_data.event_id %}'>deactivate event</a> (all draw results will be cancelled)</p>
                {% else %}

                    <p><a href='{% url "event_excludes_update" pk=event_data.event_id %}'>edit or add excludes</a></p>
                    <p><a href='{% url "event_toggle_active" pk=event_data.event_id %}'>activate the event</a> (any updates will not be possible)</p>
                {% endif %}

        </div>
        <div class="item-event drawn-name">
            <h5>Draws</h5>
            
            <div style="display: none" id="drawn_name">
            {% if draws %}
                {% for draw in draws %}
                    <p>{{draw.participant}} - {{draw.drawn_participant}} - {{draw.collected}}</p>
                {% endfor %}
            {% endif %}
            </div>
            <a class="unhide" href="#" id="unhide_name">unhide</a>

        </div>
    </div>
</div>


<script>

    function addRow() {
        const lastRow = document.querySelector('.form-row:last-child');
        const newRow = lastRow.cloneNode(true);

        const inputs = newRow.querySelectorAll('input');
        inputs.forEach(input => {
            input.value = '';
            input.classList.remove('invalid-email');
        });

        document.getElementById('form').appendChild(newRow);

        // Hide remove button in the first row
        document.querySelectorAll('.form-row .add-row-btn').forEach(btn => {
        btn.style.display = 'none';
        });

        // Show remove button in the newly added row
        newRow.querySelector('.remove-row-btn').style.display = 'inline';
        newRow.querySelector('.add-row-btn').style.display = 'inline';

        newRow.querySelector('input').focus();
        updateSubmitButtonState();
    }

    function removeRow(button) {
        const row = button.parentNode;
        const formContainer = document.getElementById('form');
        let rows_range = JSON.parse(document.getElementById('rows_range').textContent)
        console.log(formContainer);
        console.log(formContainer.childElementCount);
        console.log(rows_range)

        if (formContainer.childElementCount > rows_range + 1 ) {
            //const wasLastRow = row === formContainer.lastElementChild;
            formContainer.removeChild(row);
            updateSubmitButtonState();
            const lastRow = formContainer.lastElementChild;
            lastRow.querySelector('.add-row-btn').style.display = 'inline';
            console.log(formContainer.childElementCount);
            console.log(formContainer.lastElementChild);
        }
    }

    function checkTab(event) {
        if (event.key === 'Tab' && !event.shiftKey) {
            const focusedInput = event.target;
            const formRows = document.querySelectorAll('.form-row');
            const lastRow = formRows[formRows.length - 1];
            const lastRowInputs = lastRow.querySelectorAll('input');

            if (focusedInput === lastRowInputs[lastRowInputs.length - 1]) {
                addRow();
                event.preventDefault();
            }
        }
    }

    function validateEmail(event) {
        const emailInput = event.target;
        const isValidEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value);

        if (!isValidEmail) {
            emailInput.classList.add('invalid-email');
        } else {
            const allEmailInputs = document.querySelectorAll('input[name^="email"]');
            const isDuplicate = Array.from(allEmailInputs).some(input => input !== emailInput && input.value.trim() === emailInput.value.trim());

            if (isDuplicate) {
                console.log('duplicate')
                emailInput.classList.add('invalid-email');
                disableSubmitButton();

                console.log(document.getElementById('submit-btn'))
            } else {
                emailInput.classList.remove('invalid-email');
                updateSubmitButtonState();
            }
        }

        updateSubmitButtonState();
    }

    function disableSubmitButton() {
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.classList.remove('active');
        submitBtn.setAttribute('disabled', 'disabled');
    }

    function updateSubmitButtonState() {
        const submitBtn = document.getElementById('submit-btn');
        const emailInputs = document.querySelectorAll('input[name^="email"]');
        //const areAllEmailsValid = Array.from(emailInputs).every(input => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input.value.trim()));
        const areAllEmailsValid = Array.from(emailInputs).every(input => {
            const isValidFormat = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input.value.trim());
            const isNotDuplicate = !Array.from(emailInputs).some(otherInput => otherInput !== input && otherInput.value.trim() === input.value.trim());
            const isNotInvalid = !input.classList.contains('invalid-email');

            return isValidFormat && isNotDuplicate && isNotInvalid;
        });

        if (areAllEmailsValid) {
            submitBtn.classList.add('active');
            submitBtn.removeAttribute('disabled');
        } else {
            submitBtn.classList.remove('active');
            submitBtn.setAttribute('disabled', 'disabled');
        }
    }

    function submitForm() {
        const formRows = document.querySelectorAll('.form-row');
        const formData = [];

        formRows.forEach(row => {
            const emailInput = row.querySelector('input[name^="email"]');
            const nameInput = row.querySelector('input[name^="name"]');

            // Skip empty rows
            if (emailInput.value.trim() !== '') {
                formData.push(`${emailInput.value},${nameInput.value}`);
            }
        });

        // Join the formData array into a single string with line breaks
        const formattedData = formData.join('\n');

        // Create a hidden textarea element and append it to the form
        const textarea = document.createElement('textarea');
        textarea.name = 'participants';
        textarea.value = formattedData;
        textarea.style.display = 'none';

        const form = document.querySelector('form');
        form.appendChild(textarea);

        // Submit the form
        form.submit();
    }
</script>


{% endblock %}
